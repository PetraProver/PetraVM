<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PetraVM Opcode Benchmarks</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    /* Base Styles */
    body {
      margin: 0;
      padding: 20px;
      font-family: Georgia, 'Times New Roman', Times, serif;
      background: #ffffff;
      color: #333333;
      font-size: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* Typography */
    h1 {
      font-size: 32px;
      text-align: center;
      margin-bottom: 20px;
      font-weight: 700;
      font-family: Georgia, 'Times New Roman', Times, serif;
    }
    
    /* Controls */
    .controls {
      text-align: center;
      margin-bottom: 20px;
    }
    .controls button {
      background: #EC9A8A;
      border: none;
      color: #ffffff;
      padding: 10px 18px;
      margin: 0 8px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 16px;
      transition: background 0.2s ease;
    }
    .controls button:hover {
      opacity: 0.8;
    }
    
    /* Chart and Info Sections */
    #chart {
      width: 1200px;
      height: 600px;
      margin: 0 auto;
    }
    .benchmark-info {
      text-align: center;
      margin-bottom: 20px;
      font-style: italic;
      color: #555;
    }
    .footnote {
      margin-top: 30px;
      font-size: 14px;
      color: #666;
      text-align: center;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h1>Proving Time per 1 Million Instructions</h1>
  
  <div id="benchmark-info" class="benchmark-info">
    Benchmarked on MacBook Pro M3 18GB<br>
    <a href="https://github.com/PetraProver/PetraVM/commit/89f29cf50c4a4fb5690f0da834065737a2da1574" style="color: #666; text-decoration: underline;">
      Commit 89f29cf
    </a>
  </div>
  
  <div class="controls">
    <button id="sort-asc">Sort ↑</button>
    <button id="sort-desc">Sort ↓</button>
  </div>
  
  <div id="chart"></div>
  
  <div class="footnote">
    <p>
      Note: Data is scaled to represent time required to process 1 million VM instructions, 
      including necessary LDI and RET instructions. These additional instructions are
      consistent across all benchmarks, ensuring fair comparison.
    </p>
  </div>

  <script>
    // Color palette by category
    const categoryColors = {
      'Binary-Field':   '#EC9A8A',
      'Shift':          '#A3C9B3',
      'Multiplication': '#CEE3BC',
      'Logic':          '#D9C78C',
      'Comparison':     '#F1F2A3',
      'Arithmetic':     '#8B8459',
      'Other':          '#C1BCB3'
    };

    // Data storage
    let ops = [];

    // Fetch and process benchmark data
    function fetchData() {
      fetch('benchmarks.json')
        .then(response => {
          // Get the last modified date from the response headers
          const lastModified = response.headers.get('last-modified');
          if (lastModified) {
            const benchmarkDate = new Date(lastModified);
            const formattedDate = benchmarkDate.toLocaleDateString('en-US', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            });
            
            // Update the benchmark info with the file's last modified date
            const infoElement = document.getElementById('benchmark-info');
            const hardwareInfo = infoElement.innerHTML.split('<br>')[0];
            infoElement.innerHTML = `${hardwareInfo}<br>Benchmark date: ${formattedDate}<br><a href="https://github.com/PetraProver/PetraVM/commit/89f29cf50c4a4fb5690f0da834065737a2da1574" style="color: #666; text-decoration: underline;">Commit 89f29cf</a>`;
          }
          return response.json();
        })
        .then(data => {
          ops = data
            .filter(d => d.reason === 'benchmark-complete')
            .map(d => {
              const name = d.id.split('/').pop();
              let category;
              
              // Categorize opcodes
              if (['Xor','Xori','And','Andi','Or','Ori'].includes(name)) category = 'Logic';
              else if (['B32Mul','B32Muli','B128Add','B128Mul'].includes(name)) category = 'Binary-Field';
              else if (['Sll','Slli','Srl','Srli','Sra','Srai'].includes(name)) category = 'Shift';
              else if (['Mul','Muli','Mulu','Mulsu'].includes(name)) category = 'Multiplication';
              else if (['Add','Addi','Sub'].includes(name)) category = 'Arithmetic';
              else if (['Slt','Slti','Sltu','Sltiu','Sle','Slei','Sleu','Sleiu'].includes(name)) category = 'Comparison';
              else category = 'Other';
              
              // Convert ns to ms (*1e-6) and scale to per 1M instructions (*2)
              const meanValue = d.mean.estimate * 1e-6 * 2;
              // Using median absolute deviation (MAD) for error bars
              const madValue = d.median_abs_dev.estimate * 1e-6 * 2;
              
              return {
                opcode: name.toUpperCase(),
                mean: meanValue,
                stddev: madValue,
                category
              };
            });
          drawChart();
        });
    }

    // Draw the chart with provided data
    function drawChart(dataOps = ops) {
      const cats = [...new Set(dataOps.map(o => o.category))];
      const traces = cats.map(cat => {
        const group = dataOps.filter(o => o.category === cat);
        return {
          x: group.map(o => o.opcode),
          y: group.map(o => o.mean),
          error_y: { type: 'data', array: group.map(o => o.stddev), visible: true },
          name: cat,
          type: 'bar',
          marker: { color: categoryColors[cat] },
          hovertemplate: `<b>%{x}</b><br>Mean: %{y:.2f} ms<br>MAD: %{error_y.array:.2f} ms<extra></extra>`
        };
      });

      const layout = {
        template: 'plotly_white',
        font: { family: 'Georgia, Times New Roman, Times, serif', size: 16, color: '#333333' },
        legend: { orientation: 'h', x: 0.5, xanchor: 'center', y: 1.1, font: { size: 16 } },
        barmode: 'group',
        bargap: 0.15,
        bargroupgap: 0.1,
        margin: { l: 60, r: 30, t: 60, b: 150 },
        xaxis: { tickangle: -45, automargin: true, tickfont: { size: 16 } },
        yaxis: { title: 'Time per 1M Instructions (ms)', titlefont: { size: 18 }, gridcolor: '#e1e5ed', tickfont: { size: 16 } }
      };

      Plotly.newPlot('chart', traces, layout, { responsive: true });
    }

    // Event handlers for sorting
    document.getElementById('sort-asc').onclick = () => drawChart(ops.slice().sort((a,b) => a.mean - b.mean));
    document.getElementById('sort-desc').onclick = () => drawChart(ops.slice().sort((a,b) => b.mean - a.mean));

    // Initialize
    fetchData();
  </script>
</body>
</html>
