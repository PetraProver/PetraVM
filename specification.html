<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Specifications - The PetraVM Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The PetraVM Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="petravm-architecture"><a class="header" href="#petravm-architecture">PetraVM Architecture</a></h1>
<p><em>This specification document is still in progress.</em></p>
<h2 id="1-introduction"><a class="header" href="#1-introduction">1. Introduction</a></h2>
<p>This document specifies the architecture and behavior of the Petra Virtual Machine. Petra is a general-purpose virtual machine that is succinctly verifiable using the <a href="https://www.binius.xyz/">Binius</a> proof system [<a href="bibliography.html#binius2023">binius2023</a>]. The PetraVM execution model and instruction set are designed specifically for efficient proving with Binius.</p>
<h3 id="11-background"><a class="header" href="#11-background">1.1 Background</a></h3>
<p><a href="https://en.wikipedia.org/wiki/Verifiable_computing">Verifiable computing</a> is a technique for running an expensive computation on a powerful but untrusted server and proving its correct execution to a resource-constrained machine. Verifiable computing can be realized using a cryptographic primitive called a <em>SNARK</em>.</p>
<p>Binius is a new binary-field–based SNARK scheme with strong CPU performance and potential for best-in-class performance on custom hardware. Its native programming model, <a href="https://www.binius.xyz/basics/arithmetization/">M3</a>, is a low-level representation of formal decision languages using polynomial constraints. While M3 is flexible, it can be cumbersome for larger or more complex programs.</p>
<p>Verifiable virtual machines, like PetraVM, provide a familiar and flexible programming model, which improves the developer experience and expands the use cases for verifiable computing.</p>
<h3 id="12-project-goals"><a class="header" href="#12-project-goals">1.2. Project Goals</a></h3>
<ul>
<li><strong>Low-overhead recursion:</strong> PetraVM enables efficient recursive verification of Binius proofs.</li>
<li><strong>WebAssembly compilation:</strong> PetraVM enables verifiable general-purpose computations, via compilation of <a href="https://webassembly.org/">WebAssembly</a> programs to the PetraVM ISA.</li>
<li><strong>Efficient co-processor:</strong> PetraVM handles performance-critical computations offloaded from other compatible VMs (e.g., RISC-V zkVMs).</li>
</ul>
<h3 id="13-prior-work--inspiration"><a class="header" href="#13-prior-work--inspiration">1.3. Prior Work &amp; Inspiration</a></h3>
<p>The design and architecture of the PetraVM draws inspiration from several existing works.</p>
<ul>
<li><a href="https://eprint.iacr.org/2021/1063">Cairo</a>, a minimal, Turing-complete verifiable VM designed for STARK verification.</li>
<li><a href="https://github.com/valida-xyz/valida">Valida</a>, a VM based on RISC-V and adapted for efficient STARK verification.</li>
<li>RISC-V verifiable VMs, including <a href="https://github.com/risc0/risc0">RISC Zero</a> and <a href="https://github.com/succinctlabs/sp1">SP1</a>.</li>
</ul>
<h2 id="2-architecture-overview"><a class="header" href="#2-architecture-overview">2. Architecture Overview</a></h2>
<p>PetraVM inspired by RISC-V and makes the following notable modifications:</p>
<ul>
<li><strong>Harvard architecture</strong>. The program is stored in a read-only memory, separate from the execution state and data. This is called the program ROM, or PROM. The program may be committed to independently from the witness data, and the commitment can be included in a pre-processed verification key.</li>
<li><strong>Non-deterministic ROM</strong>. The main memory model is <em>non-deterministic read-only memory</em> (see <a href="https://eprint.iacr.org/2021/1063">Cairo</a>, Section 3.3). The intermediate computed values in the trace are placed the value ROM, or VROM. Instructions load values from VROM and assert constraint relations on them.</li>
<li><strong>Multiplicative group PROM addressing</strong>. The PROM address space is the multiplicative group of the 32-bit binary tower field. Incrementing a PROM address corresponds to multiplication by the group generator.</li>
<li><strong>Variable-length instruction encoding</strong>. Instructions are encoded as one or more 64-bit tower field elements.</li>
<li><strong>Additive subspace VROM addressing</strong>. The VROM address space is the 32-bit binary tower field, and pointer arithmetic is based on binary field addition.</li>
<li><strong>Binary field VROM words</strong>. VROM words are 32-bit binary tower field elements.</li>
<li><strong>Non-deterministic VROM allocation</strong>. Pointers to objects allocated in VROM, including pointers to function frames, are allocated non-deterministically by the prover.</li>
<li><strong>Minimal state registers</strong>. The VM uses only two state registers: the program counter (PC) and frame pointer (FP). Instructions do not read from a general-purpose register bank, instead they read from the VROM.</li>
<li><strong>Extensible instruction set</strong>. The ISA can be extended with more instructions. If an ISA extension is not used by a programe, the verifier will not incur a cost for them.</li>
</ul>
<h3 id="21-execution-model"><a class="header" href="#21-execution-model">2.1. Execution model</a></h3>
<p>The program contains a sequence of instructions structured as multiple function blocks. A <em>supervisor</em> M3 constraint system orchestrates the verification of a function call by pushing an initial program state and pulling a final program state from the state channel. The simplest supervisor would use channel boundary values to initialize and finalize the execution. The supervisor sets up the function frame of the entrypoint function by constraining the argument slots of the initial function frame.</p>
<h2 id="3-machine-specification"><a class="header" href="#3-machine-specification">3. Machine Specification</a></h2>
<h3 id="31-memory-architecture"><a class="header" href="#31-memory-architecture">3.1. Memory Architecture</a></h3>
<p>PetraVM uses a Harvard architecture with separate memory spaces:</p>
<ul>
<li><strong>Instruction Memory (PROM):</strong> Immutable, stores the program code.</li>
<li><strong>Data Memory:</strong>
<ul>
<li><strong>Value ROM (VROM):</strong> Write-once, non-deterministically populated read-only memory.</li>
<li><strong>Standard RAM:</strong> Read-write memory for dynamic data.</li>
</ul>
</li>
</ul>
<p>Each memory space (PROM, VROM, RAM) has a separate 32-bit address space.</p>
<h3 id="32-program-state-registers"><a class="header" href="#32-program-state-registers">3.2. Program State Registers</a></h3>
<ul>
<li><strong>Program Counter (PC):</strong> Points to the current instruction in PROM.</li>
<li><strong>Frame Pointer (FP):</strong> Points into VROM for the local function frame.</li>
<li><strong>Timestamp (TS):</strong> Global timestamp for RAM reads/writes (32-bit unsigned integer).</li>
</ul>
<h3 id="33-memory-addressing"><a class="header" href="#33-memory-addressing">3.3. Memory Addressing</a></h3>
<ul>
<li><strong>PROM Addressing:</strong> Uses the 32-bit field's multiplicative group. Pointer arithmetic is performed using multiplication by a fixed generator.</li>
<li><strong>VROM Addressing:</strong> Uses 32-bit addresses with access at 32-bit (word) granularity.</li>
<li><strong>RAM Addressing:</strong> Uses standard 32-bit integer addressing.</li>
</ul>
<h3 id="34-function-frames-and-calling-convention"><a class="header" href="#34-function-frames-and-calling-convention">3.4. Function Frames and Calling Convention</a></h3>
<ul>
<li>Functions execute within a frame in VROM. Frame size is statically determined.</li>
<li>Frames are 16-byte aligned.</li>
<li>Return values are treated as non-deterministic arguments to a function.</li>
<li>Frame Layout:
<ol>
<li>(32-bit) Return PC</li>
<li>(32-bit) Return FP</li>
<li>Arguments + Return Values</li>
<li>Local values</li>
</ol>
</li>
</ul>
<h3 id="35-multiplicative-pointer-arithmetic"><a class="header" href="#35-multiplicative-pointer-arithmetic">3.5. Multiplicative Pointer Arithmetic</a></h3>
<ul>
<li>PC advances via multiplication by a fixed 32-bit multiplicative group generator.</li>
<li>Incrementing PC by 1 corresponds to multiplying by the generator.</li>
<li>Address 0 indicates program exit.</li>
</ul>
<h3 id="36-exceptions"><a class="header" href="#36-exceptions">3.6. Exceptions</a></h3>
<ul>
<li>Traps set PC = 0 and FP to a non-zero value, pointing to an exception frame in VROM.</li>
<li>Exception Frame:
<ol>
<li>(32-bit) PC when the exception occurred</li>
<li>(32-bit) FP when the exception occurred</li>
<li>(8-bit) Exception reason</li>
</ol>
</li>
</ul>
<h2 id="4-instruction-set-architecture-isa"><a class="header" href="#4-instruction-set-architecture-isa">4. Instruction Set Architecture (ISA)</a></h2>
<h3 id="41-instruction-formats"><a class="header" href="#41-instruction-formats">4.1. Instruction Formats</a></h3>
<ul>
<li>Variable length, multiple of 64 bits.</li>
<li><strong>VV (Value-value):</strong> Opcode, Destination offset, Source1 offset, Source2 offset.</li>
<li><strong>VI (Value-immediate):</strong> Opcode, Destination offset, Source1 offset, Immediate value.</li>
</ul>
<h3 id="42-base-instructions"><a class="header" href="#42-base-instructions">4.2. Base Instructions</a></h3>
<ul>
<li><strong>XOR Instructions:</strong> <code>XOR</code>, <code>XORI</code></li>
<li><strong>Binary Field Instructions:</strong> <code>B32_ADD</code>, <code>B32_MUL</code>, <code>B128_ADD</code>, <code>B128_MUL</code></li>
<li><strong>Move Instructions:</strong> <code>LDI.W</code>, <code>MVV.H</code>, <code>MVV.W</code>, <code>MVV.L</code></li>
<li><strong>Jumps:</strong> <code>JUMPI</code>, <code>JUMPV</code>, <code>CALLI</code>, <code>CALLV</code>, <code>TAILI</code>, <code>TAILV</code>, <code>RET</code></li>
<li><strong>Branches:</strong> <code>BNZ</code></li>
<li><strong>Memory Access (RAM):</strong> <code>LW</code>, <code>SW</code>, <code>LB</code>, <code>LBU</code>, <code>LH</code>, <code>LHU</code>, <code>SB</code>, <code>SH</code></li>
<li><strong>Integer Instructions:</strong> <code>ADDI</code>, <code>SLTI</code>, <code>SLTIU</code>, <code>SLEI</code>, <code>SLEIU</code>, <code>ANDI</code>, <code>ORI</code>, <code>SLLI</code>, <code>SRLI</code>, <code>SRAI</code>, <code>ADD</code>, <code>SUB</code>, <code>SLT</code>, <code>SLTU</code>, <code>SLE</code>, <code>SLEU</code>, <code>AND</code>, <code>OR</code>, <code>XOR</code>, <code>SLL</code>, <code>SRL</code>, <code>SRA</code>, <code>MUL</code>, <code>MULU</code>, <code>MULSU</code></li>
</ul>
<h3 id="43-instruction-specification-examples"><a class="header" href="#43-instruction-specification-examples">4.3. Instruction Specification Examples</a></h3>
<ul>
<li><strong><code>XOR</code>:</strong>
<ul>
<li>Encoding: VV</li>
<li>Opcode: <code>0x0000</code></li>
<li>Syntax: <code>XOR dst, src1, src2</code></li>
<li>Effect: <code>fp[dst] = fp[src1] ^ fp[src2]</code></li>
</ul>
</li>
<li><strong><code>LDI.W</code>:</strong>
<ul>
<li>Description: Move 4-byte immediate value into VROM</li>
<li>Encoding: (16-bit) Opcode: <code>0x0005</code>, (16-bit) Destination offset, (32-bit) Immediate value</li>
<li>Syntax: <code>LDI.W dst, imm1</code></li>
<li>Effect: <code>fp[dst] = imm1</code></li>
</ul>
</li>
<li><strong><code>JUMPI</code>:</strong>
<ul>
<li>Description: Jump to the target address given as an immediate.</li>
<li>Encoding: (16-bit) Opcode: <code>0x000C</code>, (16-bit) Zero, (32-bit) Target address</li>
<li>Syntax: <code>J target</code></li>
<li>Effect: <code>PC = target</code></li>
</ul>
</li>
</ul>
<p><em>(Refer to the original design document for a comprehensive list of all instructions and their specifications.)</em></p>
<h3 id="44-proving-execution"><a class="header" href="#44-proving-execution">4.4. Proving Execution</a></h3>
<ul>
<li>Instruction handler tables transition and constrain program state.</li>
<li>Program state is a tuple of (PC, FP, TS).</li>
<li>Supervisor program initializes execution and handles finalization.</li>
</ul>
<h2 id="5-memory-management"><a class="header" href="#5-memory-management">5. Memory Management</a></h2>
<h3 id="51-populating-vrom"><a class="header" href="#51-populating-vrom">5.1. Populating VROM</a></h3>
<ul>
<li>VROM is populated with read values at the required granularities.</li>
<li>Verifier provides the full address space; the prover chooses which addresses to populate.</li>
</ul>
<h3 id="52-read-write-memory-argument-ram"><a class="header" href="#52-read-write-memory-argument-ram">5.2. Read-Write Memory Argument (RAM)</a></h3>
<ul>
<li>RAM uses a channel with triples (address, value, timestamp).</li>
<li>Initialization and finalization involve managing 2^k addresses with value 0 and timestamp 0.</li>
<li>Read/write operations update or read the (address, value, timestamp) triples.</li>
<li>Caching optimization using a lookup table for timestamp inequality checks.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="bibliography.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="bibliography.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>


    </div>
    </body>
</html>
